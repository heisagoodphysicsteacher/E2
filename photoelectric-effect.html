<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Photoelectric Effect Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom style for range sliders to match Tailwind theme */
        input[type=range] { accent-color: #3b82f6; }
        canvas { -ms-interpolation-mode: nearest-neighbor; image-rendering: optimizeSpeed; }
        /* Utility class to hide views */
        .view-hidden { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans p-4 md:p-6">

    <header class="max-w-6xl mx-auto mb-6 text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-blue-400 mb-4">Advanced Photoelectric Effect Lab</h1>
        <div class="inline-flex rounded-md shadow-sm text-sm font-medium" role="group">
            <button type="button" onclick="switchView('sim')" id="btn-sim" class="px-4 py-2 rounded-l-lg bg-blue-600 text-white hover:bg-blue-700 border-r border-blue-700 transition-colors">
                Simulation & Controls
            </button>
            <button type="button" onclick="switchView('iv')" id="btn-iv" class="px-4 py-2 bg-slate-700 text-slate-300 hover:bg-slate-600 hover:text-white border-r border-slate-600 transition-colors">
                I-V Graph Analysis
            </button>
            <button type="button" onclick="switchView('vsf')" id="btn-vsf" class="px-4 py-2 rounded-r-lg bg-slate-700 text-slate-300 hover:bg-slate-600 hover:text-white transition-colors">
                Vs vs. Frequency (f)
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto">

        <div id="view-sim" class="space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-8 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow relative overflow-hidden h-[350px] md:h-[400px]">
                    <h3 class="text-sm text-slate-300 font-semibold absolute top-4 left-4 z-10 bg-slate-800/80 px-2 rounded">Experimental Chamber View</h3>
                    <div class="absolute top-1/2 -translate-y-1/2 left-2 text-xs text-blue-300 font-semibold z-10 bg-slate-900/50 p-1 rounded text-center">Cathode<br>(Metal Target)</div>
                    <div class="absolute top-1/2 -translate-y-1/2 right-2 text-xs text-red-300 font-semibold z-10 bg-slate-900/50 p-1 rounded text-center">Anode<br>(Collector)</div>
                    <div class="absolute top-4 right-4 text-xs text-yellow-200 z-10">Light Source ↘</div>
                    
                    <canvas id="simCanvas" width="800" height="350" class="w-full h-full bg-slate-900/80 rounded-lg border border-slate-600"></canvas>
                </div>
                
                <div class="lg:col-span-4 grid grid-cols-2 gap-4 content-start">
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow text-center">
                        <h3 class="text-[10px] text-slate-400 uppercase font-semibold mb-1">Photon Energy (hf)</h3>
                        <div class="text-xl font-bold text-green-400 font-mono"><span id="out-energy">0.00</span> eV</div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-red-900/50 shadow text-center">
                        <h3 class="text-[10px] text-red-300 uppercase font-semibold mb-1">Stopping Potential (Vs)</h3>
                        <div class="text-xl font-bold text-red-400 font-mono"><span id="out-stopping">-0.00</span> V</div>
                        <div class="text-[10px] text-slate-500 mt-1">(Initial Max KE in eV)</div>
                    </div>
                    
                    <div class="col-span-2 bg-blue-900/20 p-4 rounded-xl border border-blue-800 shadow text-center">
                        <h3 class="text-xs text-blue-300 uppercase font-semibold mb-1">Measured Current (I)</h3>
                        <div class="text-3xl font-bold text-blue-400 font-mono"><span id="out-current">0.00</span> μA</div>
                         <div class="mt-2 flex justify-center items-center space-x-2 text-sm font-mono text-slate-400 bg-slate-800/50 p-2 rounded-lg">
                            <div class="w-8 h-8 rounded-full border-2 border-slate-500 flex items-center justify-center bg-slate-700 relative">
                                A
                                <div id="current-arrow" class="absolute -top-4 left-1/2 -translate-x-1/2 text-blue-500 text-lg opacity-0 transition-opacity">➔</div>
                            </div> 
                            <div class="h-0.5 w-4 bg-slate-600"></div>
                            <div id="battery-symbol" class="flex flex-col items-center justify-center space-y-1 px-2 border-x border-slate-600">
                                </div>
                            <div class="h-0.5 w-4 bg-slate-600"></div>
                        </div>
                    </div>

                    <div class="col-span-2 bg-slate-800 p-4 rounded-xl border border-purple-900/50 shadow text-center">
                        <h3 class="text-xs text-purple-300 uppercase font-semibold mb-1">Max KE at Anode (Final)</h3>
                        <div class="text-2xl font-bold text-purple-400 font-mono"><span id="out-ke-final">0.00</span> eV</div>
                        <div class="text-[10px] text-slate-500 mt-1">= (hf - Φ) + V_applied</div>
                    </div>

                </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                <h2 class="text-lg font-semibold text-white border-b border-slate-700 pb-3 mb-4">Experiment Parameters</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-slate-700/30 p-4 rounded-lg">
                        <label class="flex justify-between text-sm font-medium mb-2 text-slate-300">Target Work Function (Φ) <span id="val-workfunc" class="text-blue-400 font-mono">2.0 eV</span></label>
                        <input type="range" id="in-workfunc" min="1.5" max="5.0" step="0.1" value="2.0" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-slate-500 mt-1"><span>Cesium (1.9)</span><span>Copper (4.7)</span></div>
                    </div>
                    <div class="bg-slate-700/30 p-4 rounded-lg">
                         <label class="flex justify-between text-sm font-medium mb-2 text-slate-300 items-center">
                            Wavelength (λ) 
                            <div class="flex items-center space-x-2">
                                <div id="lambda-color-preview" class="w-3 h-3 rounded-full bg-purple-500"></div>
                                <span id="val-lambda" class="text-blue-400 font-mono">400 nm</span>
                            </div>
                        </label>
                        <input type="range" id="in-lambda" min="250" max="750" step="5" value="400" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                         <div class="flex justify-between text-xs text-slate-500 mt-1"><span>UV</span><span>Visible</span><span>IR</span></div>
                    </div>
                     <div class="bg-slate-700/30 p-4 rounded-lg space-y-4">
                        <div>
                            <label class="flex justify-between text-sm font-medium mb-1 text-slate-300">Light Intensity <span id="val-intensity" class="text-blue-400 font-mono">50%</span></label>
                            <input type="range" id="in-intensity" min="0" max="100" step="1" value="50" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="flex items-center justify-between">
                             <label class="block text-sm font-medium text-slate-300">Quantum Yield:</label>
                             <select id="in-efficiency" class="bg-slate-600 border-slate-500 text-slate-200 text-xs rounded p-1.5">
                                <option value="0.2">Low (Realistic)</option>
                                <option value="0.6" selected>Medium (Demo)</option>
                                <option value="1.0">Ideal (100%)</option>
                              </select>
                        </div>
                    </div>
                    <div class="bg-slate-700/50 p-4 rounded-lg border border-blue-900/30">
                        <label class="flex justify-between text-sm font-medium mb-2 text-white">Applied Voltage (V) <span id="val-voltage" class="text-blue-400 font-mono font-bold">+0.00 V</span></label>
                        <input type="range" id="in-voltage" min="-4.00" max="4.00" step="0.05" value="0.00" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                         <div class="flex justify-between text-xs text-slate-400 mt-1 mb-2">
                            <span>← Retarding (-V)</span>
                            <span>Accelerating (+V) →</span>
                        </div>
                         <p class="text-xs text-center font-semibold text-slate-300 bg-slate-800 py-1 rounded" id="voltage-status">Zero Bias</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-iv" class="view-hidden bg-slate-800 p-6 rounded-xl border border-slate-700 shadow">
            <div class="mb-4">
                <h2 class="text-xl font-bold text-slate-200">Current-Voltage (I-V) Characteristic</h2>
                <p class="text-sm text-slate-400">Observe how the photocurrent varies with applied voltage. Note the saturation current at positive voltages and the stopping potential at negative voltages.</p>
            </div>
            <div class="relative h-[400px] md:h-[500px] w-full bg-slate-900/50 rounded-lg p-2">
               <canvas id="ivGraphCanvas"></canvas>
            </div>
        </div>

        <div id="view-vsf" class="view-hidden bg-slate-800 p-6 rounded-xl border border-slate-700 shadow">
             <div class="mb-4 flex justify-between items-start">
                <div>
                    <h2 class="text-xl font-bold text-slate-200">Stopping Potential vs. Frequency (Vs against f)</h2>
                    <p class="text-sm text-slate-400 mt-1">Verifying Einstein's Equation: e Vs = hf - work function </p>
                    <ul class="text-xs text-slate-500 list-disc list-inside mt-2">
                        <li>The slope represents Planck's constant over electron charge (h / e).</li>
                        <li>The y-intercept represents negative work function in Volts ( - work function / e).</li>
                        <li>The x-intercept is the threshold frequency (fo).</li>
                    </ul>
                </div>
                <div class="bg-slate-700/50 p-3 rounded-lg text-right">
                    <div class="text-xs text-slate-400">Current Material Work Function:</div>
                    <div class="text-xl font-mono text-blue-400" id="vsf-current-phi">2.0 eV</div>
                </div>
            </div>
            <div class="relative h-[400px] md:h-[500px] w-full bg-slate-900/50 rounded-lg p-2">
               <canvas id="vsfGraphCanvas"></canvas>
            </div>
        </div>

    </main>


    <script>
        // --- Constants ---
        const HC_EV_NM = 1239.8; // More precise hc
        const C_SPEED = 2.998e8; // Speed of light m/s
        const MAX_SIM_CURRENT_UA = 8.0; // Saturation scale
        const SATURATION_VOLTAGE_THRESHOLD = 2.0; // Voltage where current effectively saturates

        // --- State Variables ---
        let state = {
            workFunction: 2.0,
            wavelength: 400,
            intensity: 50,
            efficiency: 0.6,
            voltage: 0.0,
            // Calculated values
            photonEnergy: 0,
            stoppingPotential: 0, // This is numerically equal to initial Max KE in eV
            finalMaxKE: 0, // [NEW] Max KE at anode
            saturationCurrent: 0,
            measuredCurrent: 0,
            currentColorHex: '#a855f7',
            currentView: 'sim' // 'sim', 'iv', 'vsf'
        };

        // --- DOM References ---
        const dom = {
            inputs: {
                workfunc: document.getElementById('in-workfunc'),
                lambda: document.getElementById('in-lambda'),
                intensity: document.getElementById('in-intensity'),
                efficiency: document.getElementById('in-efficiency'),
                voltage: document.getElementById('in-voltage'),
            },
            displays: {
                workfunc: document.getElementById('val-workfunc'),
                lambda: document.getElementById('val-lambda'),
                intensity: document.getElementById('val-intensity'),
                voltage: document.getElementById('val-voltage'),
                voltageStatus: document.getElementById('voltage-status'),
                lambdaPreview: document.getElementById('lambda-color-preview'),
                batterySymbol: document.getElementById('battery-symbol'),
                currentArrow: document.getElementById('current-arrow'),
                vsfPhi: document.getElementById('vsf-current-phi')
            },
            outputs: {
                energy: document.getElementById('out-energy'),
                stopping: document.getElementById('out-stopping'),
                current: document.getElementById('out-current'),
                keFinal: document.getElementById('out-ke-final'), // [NEW]
            },
            views: {
                sim: document.getElementById('view-sim'),
                iv: document.getElementById('view-iv'),
                vsf: document.getElementById('view-vsf'),
            },
            buttons: {
                sim: document.getElementById('btn-sim'),
                iv: document.getElementById('btn-iv'),
                vsf: document.getElementById('btn-vsf'),
            }
        };

        const simCanvas = document.getElementById('simCanvas');
        const simCtx = simCanvas.getContext('2d');

        // --- View Switching Logic ---
        function switchView(viewName) {
            state.currentView = viewName;
            Object.values(dom.views).forEach(v => v.classList.add('view-hidden'));
            dom.views[viewName].classList.remove('view-hidden');
            
            Object.values(dom.buttons).forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white');
                b.classList.add('bg-slate-700', 'text-slate-300');
            });
            const activeBtn = dom.buttons[viewName];
            activeBtn.classList.remove('bg-slate-700', 'text-slate-300');
            activeBtn.classList.add('bg-blue-600', 'text-white');

            if(viewName === 'iv') updateIVGraph();
            if(viewName === 'vsf') updateVsFGraph();
        }

        // --- Physics Calculations ---
        function calculateCurrentForVoltage(v, satCurrent, stopPot) {
            if (v <= -stopPot + 0.001) return 0;
            const voltageRange = SATURATION_VOLTAGE_THRESHOLD + stopPot;
            const voltageProgress = v + stopPot;
            let t = Math.max(0, voltageProgress / voltageRange);
            let current = satCurrent * Math.sqrt(t);
            return Math.min(current, satCurrent);
        }

        function calculatePhysics() {
            state.photonEnergy = HC_EV_NM / state.wavelength;
            // Initial Max KE = hf - Phi. (Numerically equal to stopping potential Vs)
            const initialMaxKE = state.photonEnergy - state.workFunction;
            state.stoppingPotential = Math.max(0, initialMaxKE);

            // [NEW] Calculate Final Max KE at Anode = Initial KE + Work done by V
            // If initial KE is negative (no emission), final KE is 0.
            // If retarding voltage is too strong, final KE will be calculated as negative, so we clamp to 0.
            if (initialMaxKE > 0) {
                state.finalMaxKE = Math.max(0, initialMaxKE + state.voltage);
            } else {
                state.finalMaxKE = 0;
            }

            const intensityFactor = state.intensity / 100;
            state.saturationCurrent = MAX_SIM_CURRENT_UA * intensityFactor * state.efficiency;

            if (state.photonEnergy <= state.workFunction) {
                state.measuredCurrent = 0;
            } else {
                state.measuredCurrent = calculateCurrentForVoltage(state.voltage, state.saturationCurrent, state.stoppingPotential);
            }
        }


        // --- UI & Charts ---

        function wavelengthToColor(wl) {
            let R, G, B, alpha=1.0;
            if (wl>=350 && wl<440) { R=-(wl-440)/(440-350); G=0; B=1; if(wl<420) alpha=0.3+0.7*(wl-350)/(420-350);}
            else if (wl>=440 && wl<490) { R=0; G=(wl-440)/(490-440); B=1; }
            else if (wl>=490 && wl<510) { R=0; G=1; B=-(wl-510)/(510-490); }
            else if (wl>=510 && wl<580) { R=(wl-510)/(580-510); G=1; B=0; }
            else if (wl>=580 && wl<645) { R=1; G=-(wl-645)/(645-580); B=0; }
            else if (wl>=645 && wl<=780) { R=1; G=0; B=0; if(wl>700) alpha=0.3+0.7*(780-wl)/(780-700);}
            else return '#555555';
            const toHex = (c) => Math.round(c * 255 * alpha).toString(16).padStart(2, '0');
            return `#${toHex(R)}${toHex(G)}${toHex(B)}`;
        }

        let ivChart, vsfChart;

        function initCharts() {
            // 1. I-V Chart Init
            const ivCtx = document.getElementById('ivGraphCanvas').getContext('2d');
            ivChart = new Chart(ivCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Theory Curve', data: [], borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, tension: 0.2
                    }, {
                        label: 'Operating Point', data: [], backgroundColor: '#ef4444', borderColor: 'white', borderWidth: 2, pointRadius: 6, showLine: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Voltage (V)', color: '#94a3b8' }, min: -4, max: 4, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { title: { display: true, text: 'Current (μA)', color: '#94a3b8' }, min: 0, max: MAX_SIM_CURRENT_UA + 0.5, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { labels: { color: '#cbd5e1' } } }
                }
            });

            // 2. Vs-f Chart Init
            const vsfCtx = document.getElementById('vsfGraphCanvas').getContext('2d');
            vsfChart = new Chart(vsfCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Vs = (h/e)f - Φ/e', data: [], borderColor: '#10b981', backgroundColor:'rgba(16, 185, 129, 0.1)', borderWidth: 2, pointRadius: 0, fill:true
                    }, {
                         label: 'Current λ Setting', data: [], backgroundColor: '#a855f7', borderColor: 'white', borderWidth: 2, pointRadius: 6, showLine: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Frequency (f) [×10¹⁴ Hz]', color: '#94a3b8' }, min: 3, max: 12, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { title: { display: true, text: 'Stopping Potential (Vs) [Volts]', color: '#94a3b8' }, min: -3, max: 4, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    },
                     plugins: { legend: { labels: { color: '#cbd5e1' } } }
                }
            });
        }

        function updateIVGraph() {
            if(state.currentView !== 'iv' && state.currentView !== 'sim') return;

            const curveData = [];
            for(let v = -4.0; v <= 4.0; v += 0.1) {
                let i = 0;
                if (state.photonEnergy > state.workFunction) {
                    i = calculateCurrentForVoltage(v, state.saturationCurrent, state.stoppingPotential);
                }
                curveData.push({x: v, y: i});
            }
            ivChart.data.datasets[0].data = curveData;
            ivChart.data.datasets[1].data = [{x: state.voltage, y: state.measuredCurrent}];
            ivChart.update();
        }

        function updateVsFGraph() {
             if(state.currentView !== 'vsf') return;
             dom.displays.vsfPhi.textContent = state.workFunction.toFixed(1) + " eV";

             const lineData = [];
             for(let f_scaled = 3.0; f_scaled <= 12.0; f_scaled += 0.5) {
                 const h_slope_approx = 0.41357; 
                 const hf_eV = h_slope_approx * f_scaled;
                 const Vs = hf_eV - state.workFunction;
                 lineData.push({x: f_scaled, y: Vs});
             }
             vsfChart.data.datasets[0].data = lineData;

             const currentF_scaled = (C_SPEED / (state.wavelength * 1e-9)) / 1e14;
             const currentVs = Math.max(0, state.photonEnergy - state.workFunction) * (state.photonEnergy > state.workFunction ? 1 : -999);
             vsfChart.data.datasets[1].data = (state.photonEnergy > state.workFunction) ? [{x: currentF_scaled, y: currentVs}] : [];
             
             vsfChart.update();
        }


        function updateUI() {
            dom.displays.workfunc.textContent = state.workFunction.toFixed(1) + " eV";
            dom.displays.lambda.textContent = state.wavelength + " nm";
            dom.displays.intensity.textContent = state.intensity + "%";
            dom.displays.voltage.textContent = (state.voltage > 0 ? "+" : "") + state.voltage.toFixed(2) + " V";
            
            state.currentColorHex = wavelengthToColor(state.wavelength);
            dom.displays.lambdaPreview.style.backgroundColor = state.currentColorHex;
            
            dom.outputs.energy.textContent = state.photonEnergy.toFixed(2);
            dom.outputs.stopping.textContent = (state.stoppingPotential > 0.01 ? "-" : "") + state.stoppingPotential.toFixed(2);
            dom.outputs.current.textContent = state.measuredCurrent.toFixed(2);
            // [NEW] Update Final KE Display
            dom.outputs.keFinal.textContent = state.finalMaxKE.toFixed(2);

            if(state.voltage > 0.05) {
                 dom.displays.voltageStatus.textContent = "Accelerating (+V) - Attracting Electrons";
                 dom.displays.batterySymbol.innerHTML = '<div class="text-green-400 font-bold">+ | | -</div>'; 
            } else if (state.voltage < -0.05) {
                 dom.displays.voltageStatus.textContent = "Retarding (-V) - Repelling Electrons";
                 dom.displays.batterySymbol.innerHTML = '<div class="text-red-400 font-bold">- | | +</div>';
            } else {
                 dom.displays.voltageStatus.textContent = "Zero Bias (V=0)";
                 dom.displays.batterySymbol.innerHTML = '<div class="text-slate-500">---</div>';
            }
            dom.displays.currentArrow.style.opacity = state.measuredCurrent > 0.05 ? '1' : '0';

            updateIVGraph();
        }

        // --- Simulation Animation Engine ---
        let photons = [], electrons = [];
        let lastFrameTime = 0;
        const CATHODE_X = 60; const ANODE_X = 740;
        const PLATE_WIDTH = 15; const PLATE_HEIGHT = 250; const PLATE_Y = 50;
        const LIGHT_SOURCE_X = 780; const LIGHT_SOURCE_Y = 20;

        function gameLoop(timestamp) {
            const deltaTime = (timestamp - lastFrameTime) / 1000;
            lastFrameTime = timestamp;
            if(state.currentView === 'sim') {
                updateSimulation(deltaTime);
                drawSimulation();
            }
            requestAnimationFrame(gameLoop);
        }

        function updateSimulation(dt) {
            // 1. Spawn Photons
            if(Math.random() < (state.intensity / 500)) {
                photons.push({
                    x: LIGHT_SOURCE_X, y: LIGHT_SOURCE_Y,
                    vx: -300 * (Math.random()*0.2 + 0.9), vy: 120 * (Math.random()*0.2 + 0.9),
                    color: state.currentColorHex
                });
            }
            photons.forEach(p => { p.x += p.vx * dt; p.y += p.vy * dt; });

            // 2. Photon Collision
            photons = photons.filter(p => {
                if (p.x > CATHODE_X && p.x < CATHODE_X + PLATE_WIDTH && p.y > PLATE_Y && p.y < PLATE_Y + PLATE_HEIGHT) {
                    if(state.photonEnergy > state.workFunction && Math.random() < state.efficiency) {
                        const keMax_eV = state.photonEnergy - state.workFunction;
                        // Base initial speed is related to sqrt(KE_initial)
                        const baseSpeed = Math.sqrt(keMax_eV) * 100; 
                        electrons.push({
                            x: CATHODE_X + PLATE_WIDTH + 2, y: p.y,
                            vx: baseSpeed * (Math.random() * 0.4 + 0.8), vy: (Math.random() - 0.5) * 30
                        });
                    }
                    return false;
                }
                return p.x > 0 && p.y < simCanvas.height;
            });

            // 3. Electron Dynamics (The Physics of V)
            // Acceleration is proportional to Voltage.
            const accelerationX = state.voltage * 400;

            electrons = electrons.filter(e => {
                e.vx += accelerationX * dt;
                e.x += e.vx * dt; e.y += e.vy * dt;
                // Collected at Anode
                if (e.x > ANODE_X && e.y > PLATE_Y && e.y < PLATE_Y + PLATE_HEIGHT) return false;
                // Retarded back to Cathode
                if (e.x < CATHODE_X + PLATE_WIDTH && e.vx < 0) return false;
                return e.y > 0 && e.y < simCanvas.height && e.x < simCanvas.width;
            });
        }

        function drawSimulation() {
            simCtx.clearRect(0, 0, simCanvas.width, simCanvas.height);
            // Plates
            simCtx.fillStyle = '#334155'; simCtx.fillRect(CATHODE_X, PLATE_Y, PLATE_WIDTH, PLATE_HEIGHT);
            simCtx.fillStyle = '#64748b'; simCtx.fillText("Cathode (-)", CATHODE_X-10, PLATE_Y + PLATE_HEIGHT + 15);
            simCtx.fillStyle = '#475569'; simCtx.fillRect(ANODE_X, PLATE_Y, PLATE_WIDTH, PLATE_HEIGHT);
            simCtx.fillStyle = '#64748b'; simCtx.fillText("Anode (+)", ANODE_X-5, PLATE_Y + PLATE_HEIGHT + 15);

            // Photons
            photons.forEach(p => {
                simCtx.strokeStyle = p.color; simCtx.lineWidth = 2; simCtx.beginPath();
                simCtx.moveTo(p.x, p.y); simCtx.lineTo(p.x + 10, p.y - 5); simCtx.stroke();
            });
            // Electrons
            simCtx.fillStyle = '#60a5fa'; electrons.forEach(e => { simCtx.beginPath(); simCtx.arc(e.x, e.y, 3, 0, Math.PI * 2); simCtx.fill(); });

             // E-Field Visual
             if(Math.abs(state.voltage) > 0.1) {
                simCtx.globalAlpha = 0.1;
                simCtx.fillStyle = state.voltage > 0 ? '#10b981' : '#ef4444';
                simCtx.fillRect(CATHODE_X + PLATE_WIDTH, PLATE_Y, ANODE_X - (CATHODE_X + PLATE_WIDTH), PLATE_HEIGHT);
                simCtx.globalAlpha = 1.0;
                simCtx.strokeStyle = state.voltage > 0 ? '#10b981' : '#ef4444';
                simCtx.beginPath();
                const midY = PLATE_Y + PLATE_HEIGHT/2;
                simCtx.moveTo(CATHODE_X + PLATE_WIDTH + 20, midY); simCtx.lineTo(ANODE_X - 20, midY);
                if(state.voltage > 0) { simCtx.moveTo(CATHODE_X + PLATE_WIDTH + 30, midY - 10); simCtx.lineTo(CATHODE_X + PLATE_WIDTH + 20, midY); simCtx.lineTo(CATHODE_X + PLATE_WIDTH + 30, midY + 10); } else { simCtx.moveTo(ANODE_X - 30, midY - 10); simCtx.lineTo(ANODE_X - 20, midY); simCtx.lineTo(ANODE_X - 30, midY + 10); }
                simCtx.stroke();
                simCtx.fillStyle = state.voltage > 0 ? '#10b981' : '#ef4444';
                simCtx.fillText("E-Field Direction", CATHODE_X + PLATE_WIDTH + 150, midY - 15);
             }
        }

        // --- Init ---
        function handleInput(e) {
            const target = e.target;
            if(target.id === 'in-workfunc') state.workFunction = parseFloat(target.value);
            if(target.id === 'in-lambda') state.wavelength = parseInt(target.value);
            if(target.id === 'in-intensity') state.intensity = parseInt(target.value);
            if(target.id === 'in-efficiency') state.efficiency = parseFloat(target.value);
            if(target.id === 'in-voltage') state.voltage = parseFloat(target.value);
            calculatePhysics(); updateUI();
            if(state.currentView === 'iv') updateIVGraph(); if(state.currentView === 'vsf') updateVsFGraph();
        }
        Object.values(dom.inputs).forEach(input => input.addEventListener('input', handleInput));
        initCharts(); calculatePhysics(); updateUI(); switchView('sim'); requestAnimationFrame(gameLoop);
    </script>
</body>
</html>

